<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>శ్రీమద్భగవద్గీత</title>

    <meta name="theme-color" content="#4f46e5"/>
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mandali&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Mandali', sans-serif; /* Apply Telugu font */
            background-color: #eef2ff; /* Lighter blue background */
            color: #374151; /* Darker gray text */
            line-height: 1.6;
            min-height: 100vh; /* Ensure body takes at least full viewport height */
            display: flex;
            flex-direction: column;
            /* Classic Bhagavad Gita Background - REPLACE THIS URL */
            background-image: url('https://github.com/adabalap/Gita/images/splash-screen.jpeg'); /* Replace with your classic background image URL for the main content background */
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Keep background fixed while scrolling */
        }

        /* Overlay for background image to improve text readability */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white overlay */
            z-index: -1; /* Place behind content */
        }

        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #6b46c1; /* Purple fallback */
             /* Classic Bhagavad Gita Image for Splash Screen - REPLACE THIS URL */
            /* Use a classic image depicting a scene from Bhagavad Gita, e.g., Krishna and Arjuna on the chariot */
            background-image: url('https://placehold.co/800x1200/a78bfa/ffffff?text=Classic+Gita+Scene'); /* REPLACE THIS URL with your actual classic image URL */
            background-size: cover;
            background-position: center;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* Slightly larger font */
            z-index: 100;
            transition: opacity 0.8s ease-in-out; /* Smoother transition */
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6); /* More prominent shadow */
        }
        .splash-screen h1 {
            font-size: 3rem; /* Larger title on splash */
            margin-bottom: 0.5rem;
        }
        .splash-screen p {
             font-size: 1.5rem;
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }

        .main-content {
            opacity: 0; /* Initially hidden */
            transition: opacity 0.8s ease-in-out; /* Smoother transition */
            flex-grow: 1; /* Allow main content to take available space */
        }
        .main-content.visible {
            opacity: 1; /* Becomes visible */
        }

        .verse-text {
            color: #059669; /* Green color for verse */
            font-size: 1.6rem; /* Slightly larger verse font */
            margin-bottom: 1rem;
            font-weight: bold;
            line-height: 1.8; /* Improved line spacing */
        }
        .meaning-text {
            color: #d97706; /* Orange color for meaning */
            font-size: 1.3rem; /* Slightly larger meaning font */
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        .description-text {
            color: #1d4ed8; /* Blue color for description */
            font-size: 1.1rem; /* Slightly larger description font */
            font-style: italic;
            margin-top: 1.5rem; /* Increased margin */
            padding-top: 1.5rem;
            border-top: 1px solid #d1d5db; /* Slightly darker border */
            line-height: 1.6;
        }
        .card {
            background-color: #ffffff; /* White card background */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            padding: 2rem; /* Increased padding */
            margin-bottom: 2rem; /* Increased margin */
            border: 1px solid #e5e7eb; /* Subtle border */
        }
        .input-group {
            display: flex;
            gap: 0.75rem; /* Increased gap */
            margin-bottom: 1.5rem; /* Increased margin */
            flex-direction: column; /* Stack vertically by default */
        }

        @media (min-width: 640px) { /* Tailwind's 'sm' breakpoint */
            .input-group {
                flex-direction: row; /* Arrange horizontally on larger screens */
            }
             .input-group select {
                flex-grow: 1;
            }
        }

        .input-group input,
        .input-group select {
            flex-grow: 1;
            padding: 0.9rem; /* Increased padding */
            border: 1px solid #d1d5db;
            border-radius: 0.5rem; /* More rounded input corners */
            background-color: #f9fafb;
            height: 48px; /* Increased height */
            font-size: 1rem; /* Standard font size */
        }

         .input-group select {
             appearance: none;
             background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.362%22%20height%3D%22292.362%22%3E%3Cpath%20fill%3D%22%231f2937%22%20d%3D%22M287.9.953a14.618%2014.618%200%200%200-21.04%200l-118.9%20118.8-118.9-118.8a14.618%2014.618%200%200%200-21.04%200%2014.618%2014.618%200%200%200%200%2021.04l129.4%20129.4a14.618%2014.618%200%200%200%2021.04%200l129.4-129.4a14.618%2014.618%200%200%200%200-21.04z%22%2F%3E%3C%2Fsvg%3E");
             background-repeat: no-repeat;
             background-position: right 0.9rem center; /* Adjusted position */
             background-size: 0.7em auto; /* Slightly larger arrow */
             padding-right: 3rem; /* Increased padding for arrow */
         }


        .btn {
            padding: 1rem 2rem; /* Increased padding */
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15); /* More prominent button shadow */
            display: flex; /* Use flexbox for icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
            font-size: 1.1rem; /* Slightly larger font size */
        }
        .btn:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Hover shadow effect */
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo */
        }
         .btn-secondary {
            background-color: #10b981; /* Emerald */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #059669; /* Darker emerald */
        }
        .message {
            margin-top: 1.5rem; /* Increased margin */
            padding: 1rem; /* Increased padding */
            border-radius: 0.5rem; /* More rounded corners */
            font-weight: medium;
            font-size: 1rem;
        }
        .message.error {
            background-color: #fee2e2; /* Red background */
            color: #991b1b; /* Dark red text */
            border: 1px solid #f87171;
        }
         .message.info {
            background-color: #dbeafe; /* Blue background */
            color: #1e40af; /* Dark blue text */
             border: 1px solid #93c5fd;
        }

        /* Styling for the verse info (Chapter, Verse numbers) */
        #verseInfo {
            font-size: 1.3rem; /* Slightly larger */
            color: #4b5563; /* Gray color */
            margin-bottom: 0.8rem; /* Increased margin */
            font-weight: normal;
            text-align: center; /* Center the verse info */
        }

        /* Ensure content is below fixed splash screen */
        .main-content {
            padding-top: 2rem; /* Add padding to prevent content from being hidden by a fixed header if one were added */
        }

    </style>
</head>
<body>

    <div class="splash-screen" id="splashScreen">
        <h1>శ్రీమద్భగవద్గీత</h1>
        <p>తెలుగులో</p>
    </div>

    <div class="main-content container mx-auto p-4" id="mainContent">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">శ్రీమద్భగవద్గీత</h1>

        <div class="controls mb-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">ఒక శ్లోకం పొందండి</h2>
            <div class="input-group">
                <select id="chapterSelect" class="focus:ring-blue-500 focus:border-blue-500">
                    <option value="">అధ్యాయం ఎంచుకోండి</option>
                </select>
                <select id="verseSelect" class="focus:ring-blue-500 focus:border-blue-500" disabled>
                    <option value="">శ్లోకం ఎంచుకోండి</option>
                </select>
            </div>
            <button class="btn btn-primary w-full mb-3" id="fetchSpecificVerseBtn">
                 <i class="ph ph-book-open"></i> నిర్దిష్ట శ్లోకం పొందండి
            </button>
            <button class="btn btn-secondary w-full" id="fetchRandomVerseBtn">
                 <i class="ph ph-shuffle"></i> యాదృచ్ఛిక శ్లోకం పొందండి
            </button>
        </div>

        <div id="verseDisplay" class="card hidden">
            <div id="verseInfo" class="text-lg font-semibold mb-2"></div>
            <div id="teluguVerse" class="verse-text"></div>
            <div id="teluguMeaning" class="meaning-text"></div>
            <div id="teluguDescription" class="description-text"></div>
        </div>

        <div id="messageArea" class="message hidden"></div>

    </div>

    <script>
        const splashScreen = document.getElementById('splashScreen');
        const mainContent = document.getElementById('mainContent');
        const verseDisplay = document.getElementById('verseDisplay');
        const verseInfo = document.getElementById('verseInfo');
        const teluguVerse = document.getElementById('teluguVerse');
        const teluguMeaning = document.getElementById('teluguMeaning');
        const teluguDescription = document.getElementById('teluguDescription');
        const chapterSelect = document.getElementById('chapterSelect');
        const verseSelect = document.getElementById('verseSelect');
        const fetchSpecificVerseBtn = document.getElementById('fetchSpecificVerseBtn');
        const fetchRandomVerseBtn = document.getElementById('fetchRandomVerseBtn');
        const messageArea = document.getElementById('messageArea');

        // Base URL for your Flask API
        const API_BASE_URL = 'http://gita.adabala.com';

        // Simple local cache using localStorage
        const verseCache = JSON.parse(localStorage.getItem('bhagavathGitaCache')) || {};

        // Define the number of verses in each chapter (same as backend)
        const CHAPTER_VERSE_COUNTS = {
            1: 46, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47,
            7: 30, 8: 28, 9: 34, 10: 42, 11: 55, 12: 20,
            13: 35, 14: 27, 15: 20, 16: 24, 17: 28, 18: 78,
        };

        // Function to show messages
        function showMessage(msg, type = 'info') {
            messageArea.textContent = msg;
            messageArea.className = `message ${type}`;
            messageArea.classList.remove('hidden');
        }

        // Function to hide messages
        function hideMessage() {
            messageArea.classList.add('hidden');
        }

        // Function to display a verse
        function displayVerse(verseData) {
            hideMessage();
            // Improved display of chapter and verse numbers
            verseInfo.innerHTML = `<span class="text-gray-600">భగవద్గీత</span> <span class="font-bold text-gray-800">[${verseData.chapter}]</span>, <span class="font-bold text-gray-800">[${verseData.verse}]</span>`;
            teluguVerse.textContent = verseData.polished_telugu_verse || verseData.telugu_verse; // Use polished if available
            teluguMeaning.textContent = verseData.polished_telugu_meaning || verseData.telugu_meaning; // Use polished if available
            teluguDescription.textContent = verseData.telugu_description || ''; // Display description if available
            verseDisplay.classList.remove('hidden');
        }

        // Function to fetch a verse from API or cache
        async function fetchVerse(chapter, verse) {
            const cacheKey = `${chapter}-${verse}`;

            // 1. Check local cache first
            if (verseCache[cacheKey]) {
                console.log(`Serving Chapter ${chapter}, Verse ${verse} from cache.`);
                displayVerse(verseCache[cacheKey]);
                return; // Exit if found in cache
            }

            // 2. If not in cache, fetch from API
            showMessage('శ్లోకం పొందుతోంది...'); // Getting verse...
            try {
                const response = await fetch(`${API_BASE_URL}/verse?chapter=${chapter}&verse=${verse}`);

                if (!response.ok) {
                    let errorDetails = `HTTP error! status: ${response.status}`;
                    try {
                         const errorData = await response.json();
                         errorDetails = errorData.error || JSON.stringify(errorData);
                    } catch (jsonError) {
                         try {
                             const errorText = await response.text();
                             errorDetails = `HTTP error! status: ${response.status}, Response Text: ${errorText}`;
                         } catch (textError) {
                             errorDetails = `HTTP error! status: ${response.status}, Could not read response body.`;
                         }
                    }
                    console.error('Fetch failed with details:', errorDetails);
                    throw new Error(errorDetails);
                }

                const data = await response.json();

                // Cache the fetched data
                verseCache[cacheKey] = data;
                localStorage.setItem('bhagavathGitaCache', JSON.stringify(verseCache));
                console.log(`Fetched Chapter ${chapter}, Verse ${verse} from API and cached.`);

                displayVerse(data);

            } catch (error) {
                console.error('Error fetching verse:', error);
                let displayMessage = `శ్లోకం పొందడంలో లోపం: ${error.message}`;
                if (!error.message || error.message === '[object Object]') {
                     console.error('Raw error object:', error);
                     displayMessage = `శ్లోకం పొందడంలో లోపం. వివరాల కోసం కన్సోల్ చూడండి.`;
                }
                showMessage(displayMessage, 'error');
                verseDisplay.classList.add('hidden');
            }
        }

        // Function to fetch a random verse
        async function fetchRandomVerse() {
             const maxChapter = 18;
             const randomChapter = Math.floor(Math.random() * maxChapter) + 1;
             const maxVerse = CHAPTER_VERSE_COUNTS[randomChapter] || 78;
             const randomVerse = Math.floor(Math.random() * maxVerse) + 1;

             console.log(`Fetching random verse: Chapter ${randomChapter}, Verse ${randomVerse}`);
             fetchVerse(randomChapter, randomVerse);
        }

        // Function to populate the chapter dropdown
        function populateChapterDropdown() {
            for (let i = 1; i <= 18; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `అధ్యాయం ${i}`;
                chapterSelect.appendChild(option);
            }
        }

        // Function to populate the verse dropdown based on selected chapter
        function populateVerseDropdown(chapter) {
            verseSelect.innerHTML = '<option value="">శ్లోకం ఎంచుకోండి</option>';
            verseSelect.disabled = true;

            if (chapter && CHAPTER_VERSE_COUNTS[chapter]) {
                const numVerses = CHAPTER_VERSE_COUNTS[chapter];
                for (let i = 1; i <= numVerses; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `శ్లోకం ${i}`;
                    verseSelect.appendChild(option);
                }
                verseSelect.disabled = false;
            }
        }

        // Event listeners
        fetchSpecificVerseBtn.addEventListener('click', () => {
            const chapter = parseInt(chapterSelect.value);
            const verse = parseInt(verseSelect.value);

            if (isNaN(chapter) || isNaN(verse) || chapter <= 0 || verse <= 0) {
                showMessage('దయచేసి అధ్యాయం మరియు శ్లోకం ఎంచుకోండి.', 'error');
                return;
            }

            fetchVerse(chapter, verse);
        });

        fetchRandomVerseBtn.addEventListener('click', fetchRandomVerse);

        chapterSelect.addEventListener('change', (event) => {
            const selectedChapter = parseInt(event.target.value);
            populateVerseDropdown(selectedChapter);
        });

        // --- Splash Screen Logic ---
        function hideSplashScreen() {
             splashScreen.classList.add('hidden');
             mainContent.classList.add('visible');
             // Optionally fetch a random verse after splash screen hides
             fetchRandomVerse();
        }

        // Hide splash screen after a delay, ensuring content is loaded
        window.addEventListener('load', () => {
            populateChapterDropdown(); // Populate dropdowns early

            // Use a combination of load event and a timeout as a fallback
            setTimeout(hideSplashScreen, 2000); // Hide after 2 seconds
        });

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                        console.error(error);
                    });
            });
        }

    </script>
</body>
</html>
