<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>శ్రీమద్భగవద్గీత</title>

    <meta name="theme-color" content="#4f46e5"/>
    <link rel="apple-touch-icon" href="/Gita/icons/icon-192x192.png">
    <link rel="manifest" href="/Gita/manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mandali&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Mandali', sans-serif; /* Apply Mandali for main text */
            background-color: #eef2ff; /* Lighter blue fallback background */
            color: #374151; /* Darker gray text */
            line-height: 1.6;
            min-height: 100vh; /* Ensure body takes at least full viewport height */
            display: flex;
            flex-direction: column;
            /* Divine Background for Main Content - Path updated for /Gita/ */
            /* Ensure you have this image or replace with a placeholder/color */
            background-image: url('/Gita/images/divine-background.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Keep background fixed while scrolling */
        }

        /* Apply Roboto to headings and UI elements */
        h1, h2, h3, button, select, input, .font-roboto {
            font-family: 'Roboto', sans-serif;
        }

        /* Overlay for background image to improve text readability */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white overlay */
            z-index: -1; /* Place behind content */
        }

        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #6b46c1; /* Purple fallback */
             /* Classic Bhagavad Gita Image for Splash Screen - Path updated for /Gita/ */
             /* Ensure you have this image or replace with a placeholder/color */
            background-image: url('/Gita/images/splash-image.jpeg');
            background-size: cover;
            background-position: center;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem; /* Slightly larger font */
            z-index: 100;
            transition: opacity 0.8s ease-in-out; /* Smoother transition */
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6); /* More prominent shadow */
        }
        .splash-screen h1 {
            font-size: 3rem; /* Larger title on splash */
            margin-bottom: 0.5rem;
        }
        .splash-screen p {
             font-size: 1.5rem;
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }

        .main-content {
            opacity: 0; /* Initially hidden */
            transition: opacity 0.8s ease-in-out; /* Smoother transition */
            flex-grow: 1; /* Allow main content to take available space */
        }
        .main-content.visible {
            opacity: 1; /* Becomes visible */
        }

        /* Styling for Sanskrit Verse */
        .sanskrit-verse-text {
            color: #059669; /* Green color for Sanskrit verse */
            font-size: 1.3rem; /* Adjusted: Smaller font */
            margin-bottom: 1rem; /* Increased margin below Sanskrit verse */
            font-weight: bold;
            line-height: 1.8; /* Improved line spacing */
            white-space: pre-wrap; /* Preserve whitespace and allow wrapping */
            text-align: center; /* Center Sanskrit verse */
            /* Removed flex as audio button is now separate */
            /* display: flex; */
            /* align-items: center; */
            /* justify-content: center; */
            /* gap: 0.5rem; */
        }

         /* Styling for the Sanskrit audio button specifically */
        /* Removed as single audio button is used */
        /* .sanskrit-verse-text .audio-button {
             color: #059669;
        } */


        /* Styling for Polished Telugu Verse (Shlokam) */
        .polished-telugu-verse-text {
            color: #4f46e5; /* Indigo color - blending with primary button color */
            font-size: 1.4rem; /* Slightly larger */
            margin-bottom: 1rem;
            line-height: 1.7;
            font-style: normal; /* Ensure not italic */
            font-weight: bold; /* Make it bold */
        }

        /* Styling for Telugu Bhavartham (Polished Meaning) */
        .telugu-bhavartham-text {
            color: #d97706; /* Orange color for meaning */
            font-size: 1.3rem; /* Slightly larger meaning font */
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        /* Styling for Sandesham (Description) */
        .sandesham-text {
            color: #1d4ed8; /* Blue color for description */
            font-size: 1.1rem; /* Slightly larger description font */
            font-style: italic;
            margin-top: 1.5rem; /* Increased margin */
            padding-top: 1.5rem;
            border-top: 1px solid #d1d5db; /* Slightly darker border */
            line-height: 1.6;
        }

        /* Styling for the main verse info heading */
        #mainVerseHeading {
            font-size: 1.6rem; /* Larger font size for main heading */
            margin-bottom: 1.5rem; /* Increased margin */
            font-weight: bold;
            text-align: center; /* Center the heading */
            /* Added gradient color for heading */
            background: linear-gradient to right, #6b46c1, #4f46e5; /* Purple to Indigo gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Hide original text color */
            display: flex; /* Use flexbox for icon and text */
            align-items: center; /* Align items vertically */
            justify-content: center; /* Center content horizontally */
            gap: 0.75rem; /* Space between icon and text */
            font-family: 'Roboto', sans-serif; /* Use Roboto for the heading */
        }

        /* Styling for labels */
        .verse-label {
            font-size: 1.1rem;
            font-weight: bold;
            /* color: #4b5563; Removed default gray color */
            margin-top: 1rem; /* Add space above labels */
            margin-bottom: 0.5rem;
            display: flex; /* Use flexbox for icon and text */
            align-items: center; /* Align items vertically */
            gap: 0.5rem; /* Space between icon and text */
        }

        /* Specific colors for labels */
        .verse-label.shlokam {
             color: #4f46e5; /* Indigo for Shlokam label */
        }
         .verse-label.bhavartham {
             color: #d97706; /* Orange for Bhavartham label */
         }
         .verse-label.sandesham {
             color: #1d4ed8; /* Blue color for Sandesham label */
         }

         /* Styling for Audio Buttons */
         .audio-button {
             background: none;
             border: none;
             cursor: pointer;
             font-size: 1.8rem; /* Larger icon size for the single button */
             padding: 0.5rem; /* Increased padding */
             color: #4f46e5; /* Indigo color for the main audio button */
             transition: color 0.2s ease-in-out;
             display: flex; /* Use flexbox for centering icon */
             align-items: center;
             justify-content: center;
             margin: 1rem auto; /* Center the single button below the content */
         }

         .audio-button:hover {
             color: #4338ca; /* Darker indigo on hover */
         }

         /* Removed specific colors for audio buttons next to labels */
         /* .verse-label.shlokam .audio-button { color: #4f46e5; } */
         /* .verse-label.bhavartham .audio-button { color: #d97706; } */
         /* .verse-label.sandesham .audio-button { color: #1d4ed8; } */


        .card {
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white card background for readability over background image */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            padding: 2rem; /* Increased padding */
            margin-bottom: 2rem; /* Increased margin */
            border: 1px solid #e5e7eb; /* Subtle border */
        }
        .input-group {
            display: flex;
            gap: 0.75rem; /* Increased gap */
            margin-bottom: 1.5rem; /* Increased margin */
            flex-direction: column; /* Stack vertically by default */
        }

        @media (min-width: 640px) { /* Tailwind's 'sm' breakpoint */
            .input-group {
                flex-direction: row; /* Arrange horizontally on larger screens */
            }
             .input-group select {
                flex-grow: 1;
            }
        }

        .input-group input,
        .input-group select {
            flex-grow: 1;
            padding: 0.9rem; /* Increased padding */
            border: 1px solid #d1d5db;
            border-radius: 0.5rem; /* More rounded input corners */
            background-color: #f9fafb;
            height: 48px; /* Increased height */
            font-size: 1rem; /* Standard font size */
        }

         .input-group select {
             appearance: none;
             background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.362%22%20height%3D%22292.362%22%3E%3Cpath%20fill%3D%22%231f2937%22%20d%3D%22M287.9.953a14.618%2014.618%200%200%200-21.04%200l-118.9%20118.8-118.9-118.8a14.618%2014.618%200%200%200-21.04%200%2014.618%2014.618%200%200%200%200%2021.04l129.4%20129.4a14.618%2014.618%200%200%200%2021.04%200l129.4-129.4a14.618%2014.618%200%200%200%200-21.04z%22%2F%3E%3C%2Fsvg%3E");
             background-repeat: no-repeat;
             background-position: right 0.9rem center; /* Adjusted position */
             background-size: 0.7em auto; /* Slightly larger arrow */
             padding-right: 3rem; /* Increased padding for arrow */
         }


        .btn {
            padding: 1rem 2rem; /* Increased padding */
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15); /* More prominent button shadow */
            display: flex; /* Use flexbox for icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
            font-size: 1.1rem; /* Slightly larger font size */
        }
        .btn:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Hover shadow effect */
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo */
        }
         .btn-secondary {
            background-color: #10b981; /* Emerald */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #059669; /* Darker emerald */
        }
        .message {
            margin-top: 1.5rem; /* Increased margin */
            padding: 1rem; /* Increased padding */
            border-radius: 0.5rem; /* More rounded corners */
            font-weight: medium;
            font-size: 1rem;
        }
        .message.error {
            background-color: #fee2e2; /* Red background */
            color: #991b1b; /* Dark red text */
            border: 1px solid #f87171;
        }
         .message.info {
            background-color: #dbeafe; /* Blue background */
            color: #1e40af; /* Dark blue text */
             border: 1px solid #93c5fd;
        }

        /* Confetti/Flower Effect Styling */
         .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow interaction with elements below */
            overflow: hidden; /* Prevent confetti from overflowing */
            z-index: 99; /* Below splash screen */
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ff0; /* Default color (yellow) */
            border-radius: 50%;
            animation: fall linear;
            opacity: 0; /* Start hidden */
        }

        /* Define different colors for confetti */
        .confetti:nth-child(3n+1) { background-color: #f00; } /* Red */
        .confetti:nth-child(3n+2) { background-color: #0f0; } /* Green */
        .confetti:nth-child(3n+3) { background-color: #00f; } /* Blue */
        .confetti:nth-child(5n+1) { background-color: #ff00ff; } /* Magenta */
        .confetti:nth-child(5n+2) { background-color: #00ffff; } /* Cyan */
        .confetti:nth-child(5n+3) { background-color: #ffa500; } /* Orange */


        /* Animation for falling confetti */
        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Social Share Styling */
        .share-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #d1d5db;
            text-align: center;
        }

        .share-container p {
            font-size: 1.1rem;
            color: #4b5563;
            margin-bottom: 1rem;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem; /* Reduced gap between icons */
            flex-wrap: wrap; /* Allow wrapping on small screens */
             /* Align icons to the top of the container */
            align-items: flex-start;
        }

        .share-button {
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center icon within the button */
            width: 40px; /* Fixed width for a small circle */
            height: 40px; /* Fixed height for a small circle */
            padding: 0; /* Remove padding */
            border-radius: 50%; /* Make it round */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
            font-size: 1.2rem; /* Icon size */
            color: white; /* Icon color */
        }

        .share-button i {
            margin-right: 0; /* Remove margin next to icon */
        }

        .share-button.whatsapp {
            background-color: #25d366; /* WhatsApp Green */
        }
        .share-button.whatsapp:hover {
            background-color: #128c7e;
        }

        .share-button.facebook {
            background-color: #1877f2; /* Facebook Blue */
        }
        .share-button.facebook:hover {
            background-color: #0b65c2;
        }

        .share-button.twitter {
            background-color: #1da1f2; /* Twitter Blue */
        }
        .share-button.twitter:hover {
            background-color: #0c85d0;
        }

        /* Instagram sharing is typically done via Web Share API or deep linking,
           direct web share buttons are less common/reliable. We'll rely on Web Share API
           or a generic copy-to-clipboard for Instagram. */
        .share-button.generic {
             background-color: #6b7280; /* Gray */
        }
         .share-button.generic:hover {
             background-color: #4b5563;
         }


        /* Footer Styling */
        footer {
            margin-top: auto; /* Push footer to the bottom */
            padding: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: #6b7280; /* Gray text */
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            border-top: 1px solid #d1d5db;
        }

        footer a {
            color: #4f46e5; /* Indigo link color */
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>

    <div class="splash-screen" id="splashScreen">
        <h1>శ్రీమద్భగవద్గీత</h1>
        <p>తెలుగులో</p>
        </div>

    <div class="main-content container mx-auto p-4 md:p-8" id="mainContent">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-8 text-gray-800 font-roboto">శ్రీమద్భగవద్గీత</h1>

        <div class="controls mb-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center font-roboto">ఒక శ్లోకం పొందండి</h2>
            <div class="input-group">
                <select id="chapterSelect" class="focus:ring-blue-500 focus:border-blue-500 font-roboto">
                    <option value="">అధ్యాయం ఎంచుకోండి</option>
                </select>
                <select id="verseSelect" class="focus:ring-blue-500 focus:border-blue-500 font-roboto" disabled>
                    <option value="">శ్లోకం ఎంచుకోండి</option>
                </select>
            </div>
            <button class="btn btn-primary w-full mb-3 font-roboto" id="fetchSpecificVerseBtn">
                 <i class="ph ph-book-open"></i> నిర్దిష్ట శ్లోకం పొందండి
            </button>
            <button class="btn btn-secondary w-full font-roboto" id="fetchRandomVerseBtn">
                 <i class="ph ph-shuffle"></i> యాదృచ్ఛిక శ్లోకం పొందండి
            </button>
        </div>

        <div id="verseDisplay" class="card hidden">
            </div>

        <div id="messageArea" class="message hidden"></div>

    </div>

    <div class="confetti-container" id="confettiContainer"></div>

    <footer>
        &copy; 2025 <a href="https://adabala.com" target="_blank">adabala.com</a>. All rights reserved.
    </footer>

    <script>
        const splashScreen = document.getElementById('splashScreen');
        const mainContent = document.getElementById('mainContent');
        const verseDisplay = document.getElementById('verseDisplay');
        const chapterSelect = document.getElementById('chapterSelect');
        const verseSelect = document.getElementById('verseSelect');
        const fetchSpecificVerseBtn = document.getElementById('fetchSpecificVerseBtn');
        const fetchRandomVerseBtn = document.getElementById('fetchRandomVerseBtn');
        const messageArea = document.getElementById('messageArea');
        const confettiContainer = document.getElementById('confettiContainer');

        // Base URL for your Flask API
        // Ensure this is HTTPS if your PWA is on HTTPS (like GitHub Pages)
        const API_BASE_URL = 'https://gita.adabala.com'; // UPDATE THIS IF YOUR API URL CHANGES

        // Simple local cache using localStorage
        const verseCache = JSON.parse(localStorage.getItem('bhagavathGitaCache')) || {};

        // Define the number of verses in each chapter (same as backend)
        const CHAPTER_VERSE_COUNTS = {
            1: 46, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47,
            7: 30, 8: 28, 9: 34, 10: 42, 11: 55, 12: 20,
            13: 35, 14: 27, 15: 20, 16: 24, 17: 28, 18: 78,
        };

        // Initialize Speech Synthesis
        const synth = window.speechSynthesis;
        let currentUtterance = null; // To keep track of the current speech

        // Function to show messages
        function showMessage(msg, type = 'info', area = messageArea) {
            area.textContent = msg;
            area.className = `message ${type}`;
            area.classList.remove('hidden');
        }

        // Function to hide messages
        function hideMessage(area = messageArea) {
            area.classList.add('hidden');
        }

        // Function to trigger confetti/flower effect
        function triggerConfetti() {
            const numConfetti = 50; // Number of confetti pieces
            const colors = ['#ff0', '#f00', '#0f0', '#0f0', '#ff00ff', '#00ffff', '#ffa500']; // Confetti colors (added more green)
            const emojis = ['🌸', '🌼', '🌺', '🌻', '🌹', '🌷']; // Flower emojis (optional)
            const animationDuration = '3s'; // Duration for one fall animation

            // Clear any existing confetti
            confettiContainer.innerHTML = '';

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');

                // Randomly choose between a colored circle or an emoji
                if (Math.random() > 0.4 && emojis.length > 0) { // Slightly increased chance of emoji
                     confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                     confetti.style.backgroundColor = 'transparent'; // No background for emoji
                     confetti.style.fontSize = `${Math.random() * 20 + 10}px`; // Random size for emoji
                     confetti.style.width = 'auto'; // Adjust width for emoji
                     confetti.style.height = 'auto'; // Adjust height for emoji
                } else {
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                }


                confetti.style.left = `${Math.random() * 100}vw`; // Random horizontal position
                // Set animation duration and delay
                confetti.style.animationDuration = animationDuration;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`; // Random delay for staggered effect
                confetti.style.opacity = 1; // Make visible when animation starts


                confettiContainer.appendChild(confetti);

                // Remove confetti after animation finishes
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        // Function to speak text
        function speakText(text, lang = 'te-IN') {
            if (synth.speaking) {
                synth.cancel(); // Stop any ongoing speech
            }
            if (text) {
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = lang; // Set language (Telugu for te-IN, Sanskrit might need a different approach or voice)
                // Optional: Set rate, pitch, or select a specific voice
                // currentUtterance.rate = 1;
                // currentUtterance.pitch = 1;
                // const voices = synth.getVoices();
                // currentUtterance.voice = voices.find(voice => voice.lang === lang); // Find a suitable voice

                synth.speak(currentUtterance);
            }
        }


        // Function to display a verse in the new format
        function displayVerse(verseData) {
            hideMessage(); // Hide main message area

            // Clear previous content
            verseDisplay.innerHTML = '';

            // Construct the new display structure
            // Use polished versions if available, otherwise fallback to original fetched
            const sanskritVerse = verseData.sanskrit_verse_telugu_script; // Get Sanskrit verse (can be null)
            const polishedTeluguVerse = verseData.polished_telugu_verse || verseData.telugu_verse || 'తెలుగు శ్లోకం అందుబాటులో లేదు.';
            const polishedTeluguMeaning = verseData.polished_telugu_meaning || verseData.telugu_meaning || 'తెలుగు భావార్థం అందుబాటులో లేదు.';
            const teluguDescription = verseData.telugu_description || 'సందేశం అందుబాటులో లేదు.';


            let contentHTML = `
                <div id="mainVerseHeading">
                    <i class="ph ph-chariot"></i> <span>భగవద్గీత</span> <span class="font-bold">[${verseData.chapter}] అధ్యాయం</span>, <span class="font-bold">[${verseData.verse}] శ్లోకం</span>
                </div>
            `;

            // Only add Sanskrit verse if it exists and is not the fallback message
            if (sanskritVerse && sanskritVerse !== 'సంస్కృత శ్లోకం అందుబాటులో లేదు.') {
                 contentHTML += `
                    <div id="sanskritVerse" class="sanskrit-verse-text">
                        ${sanskritVerse}
                    </div>
                 `;
            }


            contentHTML += `
                <div class="verse-label shlokam"><i class="ph ph-book-open"></i> శ్లోకం:</div>
                 <div id="teluguVerse" class="polished-telugu-verse-text">
                    ${polishedTeluguVerse}
                </div>

                <div class="verse-label bhavartham"><i class="ph ph-lightbulb"></i> భావార్థం:</div>
                <div id="teluguBhavartham" class="telugu-bhavartham-text">
                    ${polishedTeluguMeaning}
                </div>

                <div class="verse-label sandesham"><i class="ph ph-chat-centered-text"></i> సందేశం:</div>
                <div id="sandesham" class="sandesham-text">
                    ${teluguDescription}
                </div>

                <button class="audio-button" id="playAllAudio" title="అన్నీ వినండి">
                    <i class="ph ph-speaker-high"></i>
                </button>


                <div class="share-container">
                    <p class="font-roboto">ఈ శ్లోకాన్ని పంచుకోండి:</p>
                    <div class="share-buttons">
                        <button class="share-button whatsapp" data-platform="whatsapp" title="Share on WhatsApp">
                            <i class="ph ph-whatsapp-logo"></i>
                        </button>
                        <button class="share-button facebook" data-platform="facebook" title="Share on Facebook">
                             <i class="ph ph-facebook-logo"></i>
                        </button>
                         <button class="share-button twitter" data-platform="twitter" title="Share on Twitter">
                             <i class="ph ph-twitter-logo"></i>
                        </button>
                         <button class="share-button generic" data-platform="generic" title="Share or Copy">
                             <i class="ph ph-share-network"></i>
                        </button>
                    </div>
                </div>
            `;

            verseDisplay.innerHTML = contentHTML;
            verseDisplay.classList.remove('hidden');

            // Add event listener to the single play all audio button
            const playAllAudioButton = verseDisplay.querySelector('#playAllAudio');
            if (playAllAudioButton) {
                playAllAudioButton.addEventListener('click', () => {
                    // Concatenate all available text sections
                    let fullText = '';
                    const sanskritText = verseDisplay.querySelector('#sanskritVerse')?.textContent.trim();
                    const teluguVerseText = verseDisplay.querySelector('#teluguVerse')?.textContent.trim();
                    const teluguBhavarthamText = verseDisplay.querySelector('#teluguBhavartham')?.textContent.trim();
                    const sandeshamText = verseDisplay.querySelector('#sandesham')?.textContent.trim();

                    // Add sections if they exist, with pauses between them
                    if (sanskritText && sanskritText !== 'సంస్కృత శ్లోకం అందుబాటులో లేదు.') {
                        fullText += `${sanskritText}. `; // Add a pause after Sanskrit
                    }
                    if (teluguVerseText && teluguVerseText !== 'తెలుగు శ్లోకం అందుబాటులో లేదు.') {
                         fullText += `శ్లోకం. ${teluguVerseText}. `; // Add label and pause
                    }
                    if (teluguBhavarthamText && teluguBhavarthamText !== 'తెలుగు భావార్థం అందుబాటులో లేదు.') {
                         fullText += `భావార్థం. ${teluguBhavarthamText}. `; // Add label and pause
                    }
                     if (sandeshamText && sandeshamText !== 'సందేశం అందుబాటులో లేదు.') {
                         fullText += `సందేశం. ${sandeshamText}. `; // Add label and pause
                    }


                    // Speak the concatenated text (defaulting to Telugu language)
                    speakText(fullText.trim(), 'te-IN');
                });
            }


            // Trigger confetti effect after displaying the verse
            triggerConfetti();
        }

        // Function to fetch a verse from API or cache
        async function fetchVerse(chapter, verse) {
            const cacheKey = `${chapter}-${verse}`;

            // 1. Check local cache first
            const cachedData = verseCache[cacheKey];
            if (cachedData) {
                console.log(`Serving Chapter ${chapter}, Verse ${verse} from cache.`);
                displayVerse(cachedData);
                return; // Exit if found in cache
            }

            // 2. If not in cache, fetch from API
            showMessage('శ్లోకం పొందుతోంది...'); // Getting verse...
            try {
                console.log(`Attempting to fetch from API: ${API_BASE_URL}/verse?chapter=${chapter}&verse=${verse}`); // Log the fetch URL
                const response = await fetch(`${API_BASE_URL}/verse?chapter=${chapter}&verse=${verse}`);

                if (!response.ok) {
                    let errorDetails = `HTTP error! status: ${response.status}`;
                    try {
                         const errorData = await response.json();
                         errorDetails = errorData.error || JSON.stringify(errorData);
                    } catch (jsonError) {
                         try {
                             const errorText = await response.text();
                             errorDetails = `HTTP error! status: ${response.status}, Response Text: ${errorText}`;
                         } catch (textError) {
                             errorDetails = `HTTP error! status: ${response.status}, Could not read response body.`;
                         }
                    }
                    console.error('Fetch failed with details:', errorDetails);
                    throw new Error(errorDetails);
                }

                const data = await response.json();

                // Cache the fetched data
                verseCache[cacheKey] = data;
                localStorage.setItem('bhagavathGitaCache', JSON.stringify(verseCache));
                console.log(`Fetched Chapter ${chapter}, Verse ${verse} from API and cached.`);
                console.log('Fetched data:', data); // Log the fetched data

                displayVerse(data);

            } catch (error) {
                console.error('Error fetching verse:', error);
                let displayMessage = `శ్లోకం పొందడంలో లోపం: ${error.message}`;
                if (!error.message || error.message === '[object Object]') {
                     console.error('Raw error object:', error);
                     displayMessage = `శ్లోకం పొందడంలో లోపం. వివరాల కోసం కన్సోల్ చూడండి.`;
                }
                showMessage(displayMessage, 'error');
                verseDisplay.classList.add('hidden');
            }
        }

        // Function to fetch a random verse
        async function fetchRandomVerse() {
             const maxChapter = 18;
             const randomChapter = Math.floor(Math.random() * maxChapter) + 1;
             const maxVerse = CHAPTER_VERSE_COUNTS[randomChapter] || 78;
             const randomVerse = Math.floor(Math.random() * maxVerse) + 1;

             console.log(`Fetching random verse: Chapter ${randomChapter}, Verse ${randomVerse}`);
             fetchVerse(randomChapter, randomVerse);
        }

        // Function to populate the chapter dropdown
        function populateChapterDropdown() {
            for (let i = 1; i <= 18; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `అధ్యాయం ${i}`;
                chapterSelect.appendChild(option);
            }
        }

        // Function to populate the verse dropdown based on selected chapter
        function populateVerseDropdown(chapter) {
            verseSelect.innerHTML = '<option value="">శ్లోకం ఎంచుకోండి</option>';
            verseSelect.disabled = true;

            if (chapter && CHAPTER_VERSE_COUNTS[chapter]) {
                const numVerses = CHAPTER_VERSE_COUNTS[chapter];
                for (let i = 1; i <= numVerses; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `శ్లోకం ${i}`;
                    verseSelect.appendChild(option);
                }
                verseSelect.disabled = false;
            }
        }

        // Event listeners
        fetchSpecificVerseBtn.addEventListener('click', () => {
            const chapter = parseInt(chapterSelect.value);
            const verse = parseInt(verseSelect.value);

            if (isNaN(chapter) || isNaN(verse) || chapter <= 0 || verse <= 0) {
                showMessage('దయచేసి అధ్యాయం మరియు శ్లోకం ఎంచుకోండి.', 'error');
                return;
            }

            fetchVerse(chapter, verse);
        });

        fetchRandomVerseBtn.addEventListener('click', fetchRandomVerse);

        chapterSelect.addEventListener('change', (event) => {
            const selectedChapter = parseInt(event.target.value);
            populateVerseDropdown(selectedChapter);
        });

        // --- Splash Screen Logic ---
        function hideSplashScreen() {
             splashScreen.classList.add('hidden');
             mainContent.classList.add('visible');
             // Optionally fetch a random verse after splash screen hides
             fetchRandomVerse();
        }

        // Hide splash screen after a delay, ensuring content is loaded
        window.addEventListener('load', () => {
            populateChapterDropdown(); // Populate dropdowns early

            // Use a combination of load event and a timeout as a fallback
            setTimeout(hideSplashScreen, 2000); // Hide after 2 seconds
        });


        // --- Social Share Logic ---
        // Update this logic to construct the share text from the displayed elements
        document.addEventListener('click', (event) => {
             // Use event delegation to handle clicks on dynamically created share buttons
             if (event.target.closest('.share-button')) {
                 const button = event.target.closest('.share-button');
                 const platform = button.dataset.platform;

                 // Get content from the displayed elements
                 const mainVerseHeadingElement = document.getElementById('mainVerseHeading'); // Get the new heading
                 const sanskritVerseElement = document.getElementById('sanskritVerse');
                 const teluguVerseElement = document.getElementById('teluguVerse');
                 const teluguBhavarthamElement = document.getElementById('teluguBhavartham');
                 const sandeshamElement = document.getElementById('sandesham');

                 // Ensure elements exist before getting textContent
                 // For the main heading, get text content excluding the icon
                 // A more robust way to get text without icons might be needed for complex cases
                 const mainVerseHeadingText = mainVerseHeadingElement ? mainVerseHeadingElement.textContent.replace('భగవద్గీత', 'భగవద్గీత').trim() : '';


                 const sanskritVerseText = sanskritVerseElement ? sanskritVerseElement.textContent.replace('సంస్కృతంలో:', '').trim() : ''; // Remove label from text
                 const teluguVerseText = teluguVerseElement ? teluguVerseElement.textContent.trim() : '';
                 const teluguBhavarthamText = teluguBhavarthamElement ? teluguBhavarthamElement.textContent.trim() : '';
                 const sandeshamText = sandeshamElement ? sandeshamElement.textContent.trim() : '';


                 // Construct the share text based on the new format
                 let shareText = `${mainVerseHeadingText}\n\n`; // Start with the main heading
                 // Only include Sanskrit if it exists and is not the fallback message
                 if (sanskritVerseText && sanskritVerseText !== 'సంస్కృత శ్లోకం అందుబాటులో లేదు.') {
                     shareText += `సంస్కృతంలో:\n${sanskritVerseText}\n\n`; // Added label for Sanskrit
                 }
                  if (teluguVerseText && teluguVerseText !== 'తెలుగు శ్లోకం అందుబాటులో లేదు.') {
                     shareText += `శ్లోకం:\n${teluguVerseText}\n\n`; // Used new label
                 }
                 if (teluguBhavarthamText && teluguBhavarthamText !== 'తెలుగు భావార్థం అందుబాటులో లేదు.') {
                     shareText += `భావార్థం:\n${teluguBhavarthamText}\n\n`; // Used new label
                 }
                 if (sandeshamText && sandeshamText !== 'సందేశం అందుబాటులో లేదు.') {
                      shareText += `సందేశం:\n${sandeshamText}\n\n`;
                 }

                 shareText += `Source: adabala.com - https://adabalap.github.io/Gita/`; // Concise source/link


                 if (navigator.share) {
                     // Use Web Share API if available (for generic sharing)
                     if (platform === 'generic') {
                         navigator.share({
                             title: 'శ్రీమద్భగవద్గీత శ్లోకం', // Title for the share dialog
                             text: shareText, // The text content to share
                             url: 'https://adabalap.github.io/Gita/' // The URL to share
                         }).then(() => {
                             console.log('Successfully shared via Web Share API');
                         }).catch((error) => {
                             console.error('Error sharing via Web Share API:', error);
                             // Fallback for generic share if Web Share API fails
                             copyToClipboard(shareText);
                             showMessage('శ్లోకం కాపీ చేయబడింది! మీరు ఇప్పుడు దీన్ని ఎక్కడైనా పంచుకోవచ్చు.', 'info'); // Verse copied! You can now share it anywhere.
                         });
                     } else {
                          // For specific platforms, try Web Share API first, then fallback
                          // Web Share API is the preferred method as it leverages native sharing.
                          navigator.share({
                             title: 'శ్రీమద్భగవద్గీత శ్లోకం',
                             text: shareText,
                             url: 'https://adabalap.github.io/Gita/'
                          }).then(() => {
                              console.log(`Successfully shared to ${platform} via Web Share API`);
                          }).catch((error) => {
                              console.error(`Error sharing to ${platform} via Web Share API:`, error);
                              // Fallback to specific platform web intents if Web Share API fails
                              handleSpecificPlatformShare(platform, shareText);
                          });
                     }
                 } else {
                     // Fallback for browsers that don't support Web Share API
                     handleSpecificPlatformShare(platform, shareText);
                 }
             }
        });


        // Fallback function for specific platform sharing (opens new tab)
        // Note: Web Share API is generally more reliable for opening native apps
        // compared to these web intents, which might open the web version or fail.
        function handleSpecificPlatformShare(platform, text) {
             const url = encodeURIComponent(text);
             let shareUrl = '';

             switch (platform) {
                 case 'whatsapp':
                     // WhatsApp Web Share URL
                     shareUrl = `https://wa.me/?text=${url}`;
                     // Alternative: whatsapp://send?text=${url} (might work better on some mobile devices, but less universally supported)
                     break;
                 case 'facebook':
                     // Facebook sharing is complex, often requires their SDK or a share dialog.
                     // A simple text share link is not officially supported or reliable for native app.
                     // This will likely open their web share dialog.
                     shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://adabalap.github.io/Gita/')}&quote=${url}`;
                     break;
                 case 'twitter':
                     // Twitter Web Intent URL
                     shareUrl = `https://twitter.com/intent/tweet?text=${url}`;
                     break;
                 case 'generic':
                     // Fallback for generic share - copy to clipboard
                     copyToClipboard(text);
                     showMessage('శ్లోకం కాపీ చేయబడింది! మీరు ఇప్పుడు దీన్ని ఎక్కడైనా పంచుకోవచ్చు.', 'info'); // Verse copied! You can now share it anywhere.
                     return; // Don't open a new window for copy
             }

             if (shareUrl) {
                 window.open(shareUrl, '_blank');
             } else if (platform !== 'generic') {
                 // If a specific platform link wasn't generated, suggest copying
                 copyToClipboard(text);
                 showMessage('ఈ ప్లాట్‌ఫారమ్‌కు నేరుగా భాగస్వామ్యం చేయడం సాధ్యం కాలేదు. శ్లోకం కాపీ చేయబడింది!', 'info'); // Direct sharing to this platform failed. Verse copied!
             }
        }

        // Function to copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            // Styling to make the textarea invisible but selectable
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Unable to copy to clipboard', err);
            }
            document.body.removeChild(textarea);
        }


        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Register Service Worker with scope for /Gita/ subfolder
                navigator.serviceWorker.register('/Gita/service-worker.js', { scope: '/Gita/' })
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                        console.error('Ensure service-worker.js is at the root of your /Gita/ subfolder on GitHub Pages.');
                        console.error(error);
                    });
            });
        }

        // --- Offline Data Display from Cache ---
        // This is handled implicitly by the fetchVerse function.
        // When offline, the fetch() request will fail, but the Service Worker
        // might intercept it and serve from the cache if the API response was cached.
        // Additionally, the localStorage cache check at the beginning of fetchVerse
        // allows displaying previously viewed verses even if the Service Worker cache is missed
        // for the API request itself (though the Service Worker should ideally cache API responses too).
        // To explicitly handle offline *initial* load for a specific verse (e.g., last viewed),
        // you could add logic here on window.load to check localStorage and display if available.

        window.addEventListener('online', () => {
            console.log('App is online.');
            // Optional: Re-fetch current verse or sync data if needed
        });

        window.addEventListener('offline', () => {
            console.log('App is offline.');
            // Optional: Display an offline message to the user
            showMessage('మీరు ఆఫ్‌లైన్‌లో ఉన్నారు. కాష్ చేయబడిన శ్లోకాలు మాత్రమే అందుబాటులో ఉండవచ్చు.', 'info'); // You are offline. Only cached verses may be available.
        });


    </script>
</body>
</html>
